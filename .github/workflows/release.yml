name: Auto Build and Release
on:
  push:
    tags: v*  # ç›‘å¬ v å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1ï¼šæ‹‰å–ä»£ç ï¼ˆå¼ºåˆ¶ HTTPS åè®®æ‹‰å–å­æ¨¡å—ï¼‰
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # æ­¥éª¤ 2ï¼šè·å–ç‰ˆæœ¬ä¿¡æ¯
      - name: Extract version info
        id: version-info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          cd backend
          BACKEND_TAG=$(git describe --tags --abbrev=0 || echo "unknown")
          cd ../frontend
          FRONTEND_TAG=$(git describe --tags --abbrev=0 || echo "unknown")
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FRONTEND_TAG=$FRONTEND_TAG" >> $GITHUB_ENV

      # æ­¥éª¤ 3ï¼šå®‰å…¨æ‰“åŒ…ï¼ˆä¿®å¤é€’å½’å¤åˆ¶é—®é¢˜ï¼‰
      - name: Create full package
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p package
          # å¤åˆ¶æ–‡ä»¶ï¼ˆæ’é™¤.gitå’Œ.githubï¼‰
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.DS_Store' \
            --exclude='package' \
            ./ package/
          # é‡å‘½åå¹¶å‹ç¼©
          mv package auth-matrix-${{ env.TAG_NAME }}
          zip -r auth-matrix-${{ env.TAG_NAME }}-full.zip auth-matrix-${{ env.TAG_NAME }}

      # æ­¥éª¤ 4ï¼šç”ŸæˆåŠ¨æ€ Release æè¿°
      - name: Generate release notes
        run: |
          cat << EOF > release-body.md
          ## ğŸš€ Auth-Matrix ${{ env.TAG_NAME }}

          ### ğŸ“¦ Component Versions
          | Module  | Version   | Repository |
          |---------|-----------|------------|
          | Backend | ${{ env.BACKEND_TAG }} | [Link](${{ github.server_url }}/thirty30ww/auth-matrix-backend/tree/${{ env.BACKEND_TAG }}) |
          | Frontend| ${{ env.FRONTEND_TAG }} | [Link](${{ github.server_url }}/thirty30ww/auth-matrix-frontend/tree/${{ env.FRONTEND_TAG }}) |

          ### â¬‡ï¸ Installation
          **Option 1: Clone with submodules**
          \`\`\`bash
          git clone --recurse-submodules ${{ github.server_url }}/thirty30ww/auth-matrix.git -b ${{ env.TAG_NAME }}
          \`\`\`

          **Option 2: Download ZIP**  
          Use the \`auth-matrix-${{ env.TAG_NAME }}-full.zip\` attachment below.
          EOF

      # æ­¥éª¤ 5ï¼šåˆ›å»º Release
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Auth-Matrix ${{ env.TAG_NAME }}"
          body_path: release-body.md
          files: auth-matrix-${{ env.TAG_NAME }}-full.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}