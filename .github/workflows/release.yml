name: å®Œæ•´ç‰ˆæœ¬å‘å¸ƒï¼ˆæ‰“åŒ…+æè¿°ç”Ÿæˆï¼‰
on:
  push:
    tags: v*  # æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1ï¼šæ‹‰å–å…ƒä»“åº“åŠæ‰€æœ‰å­æ¨¡å—ä»£ç 
      - name: æ‹‰å–ä»£ç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: recursive  # é€’å½’æ‹‰å–å­æ¨¡å—
          fetch-depth: 0         # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

      # æ­¥éª¤ 2ï¼šè·å–å­æ¨¡å—çš„æœ€æ–°æ ‡ç­¾ï¼ˆç¡®ä¿å‰åç«¯å­æ¨¡å—å·²æ‰“æ ‡ç­¾ï¼‰
      - name: è·å–å­æ¨¡å—ç‰ˆæœ¬
        id: submodule-versions
        run: |
          # è¿›å…¥åç«¯ä»“åº“ï¼Œè·å–æœ€æ–°æ ‡ç­¾
          cd backend
          BACKEND_TAG=$(git describe --tags --abbrev=0)
          cd ..
          
          # è¿›å…¥å‰ç«¯ä»“åº“ï¼Œè·å–æœ€æ–°æ ‡ç­¾
          cd frontend
          FRONTEND_TAG=$(git describe --tags --abbrev=0)
          cd ..
          
          # å°†ç‰ˆæœ¬å·è¾“å‡ºä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FRONTEND_TAG=$FRONTEND_TAG" >> $GITHUB_ENV

      # æ­¥éª¤ 3ï¼šåŠ¨æ€ç”Ÿæˆ Release æè¿°ï¼ˆMarkdown å†…å®¹ï¼‰
      - name: ç”Ÿæˆ Release æè¿°
        id: generate-release-body
        run: |
          # ç”Ÿæˆ Markdown å†…å®¹ï¼ŒåŒ…å«å­æ¨¡å—ç‰ˆæœ¬ã€å®‰è£…å‘½ä»¤ç­‰
          RELEASE_BODY=$(cat << EOF
          ## ğŸš€ Auth-Matrix v${{ github.ref_name }} å‘å¸ƒè¯´æ˜
          
          ### ğŸ“Œ å­æ¨¡å—ç‰ˆæœ¬å…³è”
          | æ¨¡å—   | ç‰ˆæœ¬   | ä»“åº“åœ°å€ |
          |--------|--------|----------|
          | åç«¯   | ${{ env.BACKEND_TAG }} | [backend](https://github.com/thirty30ww/auth-matrix-backend/releases/tag/${{ env.BACKEND_TAG }}) |
          | å‰ç«¯   | ${{ env.FRONTEND_TAG }} | [frontend](https://github.com/thirty30ww/auth-matrix-frontend/releases/tag/${{ env.FRONTEND_TAG }}) |
          
          ### â¬‡ï¸ å®‰è£…æ–¹å¼ï¼ˆäºŒé€‰ä¸€ï¼‰
          #### æ–¹å¼ 1ï¼šGit å…‹éš†ï¼ˆæ¨èå¼€å‘è€…ï¼‰
          \`\`\`bash
          git clone --recurse-submodules https://github.com/thirty30ww/auth-matrix.git -b ${{ github.ref_name }}
          cd auth-matrix
          # å¯åŠ¨åç«¯ï¼šcd backend && ./mvnw spring-boot:run
          # å¯åŠ¨å‰ç«¯ï¼šcd frontend && npm install && npm run dev
          \`\`\`
          
          #### æ–¹å¼ 2ï¼šä¸‹è½½å®Œæ•´ä»£ç åŒ…ï¼ˆé€‚åˆéƒ¨ç½²ï¼‰
          ç‚¹å‡»ä¸‹æ–¹ \`auth-matrix-${{ github.ref_name }}-full.zip\` ä¸‹è½½å…¨éƒ¨ä»£ç ã€‚
          EOF
          )
          
          # å°† Markdown å†…å®¹è¾“å‡ºä¸ºç¯å¢ƒå˜é‡ï¼ˆæ³¨æ„è½¬ä¹‰æ¢è¡Œç¬¦ï¼‰
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # æ­¥éª¤ 4ï¼šæ‰“åŒ…å®Œæ•´ä»£ç ï¼ˆå«å­æ¨¡å—ï¼‰
      - name: æ‰“åŒ…ä»£ç ä¸º ZIP
        run: |
          # åˆ›å»ºå¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶å¤¹ï¼Œé¿å…è§£å‹æ··ä¹±
          mkdir -p auth-matrix-${{ github.ref_name }}
          cp -r ./* auth-matrix-${{ github.ref_name }}/
          # æ’é™¤ .git å’Œ GitHub Actions ç›¸å…³æ–‡ä»¶
          zip -r auth-matrix-${{ github.ref_name }}-full.zip auth-matrix-${{ github.ref_name }} -x "*.git*" ".github/*"

      # æ­¥éª¤ 5ï¼šåˆ›å»º Release å¹¶ä¸Šä¼ èµ„äº§å’ŒåŠ¨æ€æè¿°
      - name: åˆ›å»º Release å¹¶ä¸Šä¼ å†…å®¹
        uses: softprops/action-gh-release@v1  # æ›´å¼ºå¤§çš„ Release ç”Ÿæˆå·¥å…·
        with:
          name: "Auth-Matrix v${{ github.ref_name }}"  # Release æ ‡é¢˜
          body: ${{ env.RELEASE_BODY }}                # åŠ¨æ€ç”Ÿæˆçš„ Markdown æè¿°
          files: auth-matrix-${{ github.ref_name }}-full.zip  # ä¸Šä¼ æ‰“åŒ…çš„ä»£ç 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub è‡ªåŠ¨æä¾›çš„å¯†é’¥