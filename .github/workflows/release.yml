name: è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒ
on:
  push:
    tags: v*  # ç›‘å¬ v å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release
    steps:
      # æ­¥éª¤ 1ï¼šæ‹‰å–ä»£ç ï¼ˆæ”¯æŒ SSH å­æ¨¡å—å…‹éš†ï¼‰
      - name: æ‹‰å–ä»£ç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: recursive  # é€’å½’æ‹‰å–å­æ¨¡å—
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}  # ç”¨äº SSH å­æ¨¡å—å…‹éš†ï¼ˆéœ€é…ç½®ï¼‰

      # æ­¥éª¤ 2ï¼šè·å–å­æ¨¡å—ç‰ˆæœ¬ï¼ˆä¿®å¤ unknown é—®é¢˜ï¼‰
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version-info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # è·å–åç«¯ç‰ˆæœ¬ï¼ˆä¼˜å…ˆæ ‡ç­¾ï¼Œæ— æ ‡ç­¾åˆ™ç”¨åˆ†æ”¯åï¼‰
          cd backend
          BACKEND_TAG=$(git describe --tags --abbrev=0 2>/dev/null || git rev-parse --abbrev-ref HEAD)
          cd ..
          
          # è·å–å‰ç«¯ç‰ˆæœ¬ï¼ˆä¼˜å…ˆæ ‡ç­¾ï¼Œæ— æ ‡ç­¾åˆ™ç”¨åˆ†æ”¯åï¼‰
          cd frontend
          FRONTEND_TAG=$(git describe --tags --abbrev=0 2>/dev/null || git rev-parse --abbrev-ref HEAD)
          cd ..
          
          # è¾“å‡ºç¯å¢ƒå˜é‡
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FRONTEND_TAG=$FRONTEND_TAG" >> $GITHUB_ENV

      # æ­¥éª¤ 3ï¼šå®‰å…¨æ‰“åŒ…ï¼ˆä»…ä¿ç•™ç›®æ ‡å‹ç¼©åŒ…ï¼‰
      - name: åˆ›å»ºå®Œæ•´ä»£ç åŒ…
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p package
          
          # å¤åˆ¶æ–‡ä»¶ï¼ˆæ’é™¤ä¸éœ€è¦çš„ç›®å½•ï¼‰
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.DS_Store' \
            --exclude='package' \
            ./ package/
          
          # é‡å‘½åç›®å½•å¹¶å‹ç¼©ï¼ˆå‘½åä¸º auth-matrix.zipï¼‰
          mv package auth-matrix
          zip -r auth-matrix.zip auth-matrix

      # æ­¥éª¤ 4ï¼šç”Ÿæˆä¸­æ–‡ Release æè¿°
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          cat << EOF > release-body.md
          ## ğŸš€ Auth-Matrix ${{ env.TAG_NAME }}
          
          ### ğŸ“¦ ç»„ä»¶ç‰ˆæœ¬ä¿¡æ¯
          | æ¨¡å—   | ç‰ˆæœ¬       | ä»“åº“åœ°å€                                                                 |
          |--------|------------|--------------------------------------------------------------------------|
          | åç«¯   | ${{ env.BACKEND_TAG }} | [æŸ¥çœ‹åç«¯](${{ github.server_url }}/thirty30ww/auth-matrix-backend/tree/${{ env.BACKEND_TAG }}) |
          | å‰ç«¯   | ${{ env.FRONTEND_TAG }} | [æŸ¥çœ‹å‰ç«¯](${{ github.server_url }}/thirty30ww/auth-matrix-frontend/tree/${{ env.FRONTEND_TAG }}) |
          
          ### â¬‡ï¸ è·å–ä»£ç 
          **æ–¹å¼ä¸€ï¼šå…‹éš†ä»“åº“ï¼ˆæ¨èå¼€å‘è€…ï¼‰**
          \`\`\`bash
          git clone --recurse-submodules ${{ github.server_url }}/thirty30ww/auth-matrix.git -b ${{ env.TAG_NAME }}
          \`\`\`
          
          **æ–¹å¼äºŒï¼šä¸‹è½½å®Œæ•´åŒ…ï¼ˆé€‚åˆéƒ¨ç½²ï¼‰**  
          ç›´æ¥ä¸‹è½½ä¸‹æ–¹çš„ \`auth-matrix.zip\` å³å¯ä½¿ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚
          EOF

      # æ­¥éª¤ 5ï¼šåˆ›å»º Releaseï¼ˆä»…ä¿ç•™è‡ªå®šä¹‰èµ„äº§ï¼‰
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Auth-Matrix ${{ env.TAG_NAME }}"
          body_path: release-body.md
          files: auth-matrix.zip  # ä»…ä¸Šä¼ è‡ªå®šä¹‰å‹ç¼©åŒ…
          generate_release_notes: false  # ç¦ç”¨é»˜è®¤çš„æºç åŒ…ç”Ÿæˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}