name: è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒ
on:
  push:
    tags: v*

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä¸»ä»“åº“å’Œå­æ¨¡å—
      - name: æ‹‰å–ä»£ç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤2ï¼šè·å–å­æ¨¡å—ç‰ˆæœ¬ä¿¡æ¯å’Œä»“åº“è·¯å¾„
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version-info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # è·å–åç«¯ä¿¡æ¯
          cd backend
          BACKEND_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
          BACKEND_REPO=$(git remote get-url origin | sed 's|git@github.com:||; s|\.git$||')
          cd ..
          
          # è·å–å‰ç«¯ä¿¡æ¯
          cd frontend
          FRONTEND_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
          FRONTEND_REPO=$(git remote get-url origin | sed 's|git@github.com:||; s|\.git$||')
          cd ..
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FRONTEND_TAG=$FRONTEND_TAG" >> $GITHUB_ENV
          echo "BACKEND_REPO=$BACKEND_REPO" >> $GITHUB_ENV
          echo "FRONTEND_REPO=$FRONTEND_REPO" >> $GITHUB_ENV

      # æ­¥éª¤3ï¼šæ‰“åŒ…å®Œæ•´ä»£ç 
      - name: åˆ›å»ºå®Œæ•´ä»£ç åŒ…
        run: |
          mkdir -p package
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.DS_Store' \
            --exclude='package' \
            ./ package/
          mv package auth-matrix
          zip -r auth-matrix.zip auth-matrix

      # æ­¥éª¤4ï¼šç”Ÿæˆå¸¦é“¾æ¥çš„å‘å¸ƒè¯´æ˜
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          cat << EOF > release-body.md
          ## ğŸš€ Auth-Matrix ${{ env.TAG_NAME }}
          
          ### ğŸ“¦ ç»„ä»¶ç‰ˆæœ¬ä¿¡æ¯
          | æ¨¡å—   | ç‰ˆæœ¬       | å‘å¸ƒé“¾æ¥ |
          |--------|------------|----------|
          | åç«¯   | ${{ env.BACKEND_TAG }} | [æŸ¥çœ‹](${{ env.BACKEND_REPO }}/releases/tag/${{ env.BACKEND_TAG }}) |
          | å‰ç«¯   | ${{ env.FRONTEND_TAG }} | [æŸ¥çœ‹](${{ env.FRONTEND_REPO }}/releases/tag/${{ env.FRONTEND_TAG }}) |

          ## ğŸ”» ä»£ç è·å–æ–¹å¼
          ### æ–¹å¼ä¸€ï¼šå®Œæ•´åŒ…ä¸‹è½½
          ç›´æ¥ä¸‹è½½å³ä¾§ auth-matrix.zipï¼ˆå·²åŒ…å«æ‰€æœ‰å­æ¨¡å—çš„ä»£ç ï¼Œæ— éœ€æ‰‹åŠ¨ä¸‹è½½ï¼‰

          ### æ–¹å¼äºŒï¼šç²¾å‡†ç‰ˆæœ¬å…‹éš†
          \`\`\`bash
          # å…‹éš†é¡¹ç›®ï¼Œä¸¤ç§ä¸­ä»»æ„ä¸€ç§ï¼ˆåŒ…å«å­æ¨¡å—ï¼‰
          git clone --branch ${{ env.TAG_NAME }} --recursive https://github.com/thirty30ww/auth-matrix.git # å…‹éš†é¡¹ç›®ï¼Œhttpæ–¹å¼
          git clone --branch ${{ env.TAG_NAME }} --recursive git@github.com:thirty30ww/auth-matrix.git # å…‹éš†é¡¹ç›®ï¼Œsshæ–¹å¼
          \`\`\`
          EOF

      # æ­¥éª¤5ï¼šåˆ›å»º Release
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Auth-Matrix ${{ env.TAG_NAME }}"
          body_path: release-body.md
          files: auth-matrix.zip
          generate_release_notes: false