name: è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒ
on:
  push:
    tags: v*  # ç›‘å¬ v å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # æ­¥éª¤ 1ï¼šæ‹‰å–ä¸»ä»“åº“ï¼ˆä¸åŒ…å«å­æ¨¡å—ï¼Œåç»­æ‰‹åŠ¨å¤„ç†ï¼‰
      - name: æ‹‰å–ä¸»ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: false  # å…ˆç¦ç”¨è‡ªåŠ¨å­æ¨¡å—æ‹‰å–
          fetch-depth: 0     # æ‹‰å–å®Œæ•´å†å²

      # æ­¥éª¤ 2ï¼šæ‰‹åŠ¨åˆå§‹åŒ–å­æ¨¡å—ï¼ˆè§£å†³æƒé™å’Œå¼•ç”¨é—®é¢˜ï¼‰
      - name: åˆå§‹åŒ–å­æ¨¡å—
        run: |
          # é…ç½® SSH è®¤è¯
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # æ‰‹åŠ¨åˆå§‹åŒ–å­æ¨¡å—
          git submodule init
          git submodule update --force --recursive --remote

      # æ­¥éª¤ 3ï¼šè·å–å„ä»“åº“å®é™…ç‰ˆæœ¬
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version-info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # è·å–åç«¯æœ€æ–°æ ‡ç­¾
          cd backend
          git fetch --tags --force
          BACKEND_TAG=$(git describe --tags --abbrev=0 || echo "no-tag")
          cd ..
          
          # è·å–å‰ç«¯æœ€æ–°æ ‡ç­¾
          cd frontend
          git fetch --tags --force
          FRONTEND_TAG=$(git describe --tags --abbrev=0 || echo "no-tag")
          cd ..
          
          # è¾“å‡ºç¯å¢ƒå˜é‡
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FRONTEND_TAG=$FRONTEND_TAG" >> $GITHUB_ENV

      # æ­¥éª¤ 4ï¼šæ‰“åŒ…ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: åˆ›å»ºå®Œæ•´ä»£ç åŒ…
        run: |
          mkdir -p package
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.DS_Store' \
            --exclude='package' \
            ./ package/
          mv package auth-matrix
          zip -r auth-matrix.zip auth-matrix

      # æ­¥éª¤ 5ï¼šç”Ÿæˆ Release æè¿°
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          cat << EOF > release-body.md
          ## ğŸš€ Auth-Matrix ${{ env.TAG_NAME }}
          
          ### ğŸ“¦ ç»„ä»¶ç‰ˆæœ¬ä¿¡æ¯
          | æ¨¡å—   | ç‰ˆæœ¬       |
          |--------|------------|
          | åç«¯   | ${{ env.BACKEND_TAG }} |
          | å‰ç«¯   | ${{ env.FRONTEND_TAG }} |
          
          ### â¬‡ï¸ ä¸‹è½½å®Œæ•´åŒ…
          ç›´æ¥ä¸‹è½½ä¸‹æ–¹çš„ \`auth-matrix.zip\` å³å¯ä½¿ç”¨ã€‚
          EOF

      # æ­¥éª¤ 6ï¼šåˆ›å»º Release
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Auth-Matrix ${{ env.TAG_NAME }}"
          body_path: release-body.md
          files: auth-matrix.zip
          generate_release_notes: false