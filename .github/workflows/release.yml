name: Auto Build and Release
on:
  push:
    tags: v*  # ç›‘å¬ v å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1ï¼šæ‹‰å–ä»£ç ï¼ˆå¼ºåˆ¶ HTTPS åè®®æ‹‰å–å­æ¨¡å—ï¼‰
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}  # è¦†ç›– .gitmodules ä¸­çš„ SSH åè®®
          persist-credentials: true

      # æ­¥éª¤ 2ï¼šè·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç»Ÿä¸€ä½¿ç”¨ github.ref_nameï¼‰
      - name: Extract version info
        id: version-info
        run: |
          # è·å–æ ‡ç­¾åï¼ˆå¦‚ v1.0.0ï¼‰
          TAG_NAME=${GITHUB_REF#refs/tags/}
          # è¿›å…¥å­æ¨¡å—è·å–æ ‡ç­¾ï¼ˆç¡®ä¿å·²æ£€å‡ºæ­£ç¡®ç‰ˆæœ¬ï¼‰
          cd backend
          BACKEND_TAG=$(git describe --tags --abbrev=0 || echo "unknown")
          cd ../frontend
          FRONTEND_TAG=$(git describe --tags --abbrev=0 || echo "unknown")
          # è¾“å‡ºæ ‡å‡†åŒ–å˜é‡
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FRONTEND_TAG=$FRONTEND_TAG" >> $GITHUB_ENV

      # æ­¥éª¤ 3ï¼šæ‰“åŒ…å®Œæ•´ä»£ç ï¼ˆæ’é™¤ .git æ–‡ä»¶ï¼‰
      - name: Create full package
        run: |
          mkdir -p auth-matrix-${{ env.TAG_NAME }}
          cp -r ./* auth-matrix-${{ env.TAG_NAME }}/
          zip -r auth-matrix-${{ env.TAG_NAME }}-full.zip \
            auth-matrix-${{ env.TAG_NAME }} \
            -x "*.git*" ".github/*" "*.DS_Store"

      # æ­¥éª¤ 4ï¼šç”ŸæˆåŠ¨æ€ Markdown æè¿°ï¼ˆä¸¥æ ¼å¯¹é½å˜é‡ï¼‰
      - name: Generate release notes
        run: |
          cat << EOF > release-body.md
          ## ğŸš€ Auth-Matrix ${{ env.TAG_NAME }}

          ### ğŸ“¦ ç»„ä»¶ç‰ˆæœ¬
          | æ¨¡å—   | ç‰ˆæœ¬       | ä»“åº“åœ°å€                                                                 |
          |--------|------------|--------------------------------------------------------------------------|
          | åç«¯   | ${{ env.BACKEND_TAG }} | [backend](${{ github.server_url }}/thirty30ww/auth-matrix-backend/tree/${{ env.BACKEND_TAG }}) |
          | å‰ç«¯   | ${{ env.FRONTEND_TAG }} | [frontend](${{ github.server_url }}/thirty30ww/auth-matrix-frontend/tree/${{ env.FRONTEND_TAG }}) |

          ### â¬‡ï¸ è·å–ä»£ç 
          **æ–¹å¼ä¸€ï¼šå…‹éš†ä»“åº“**
          \`\`\`bash
          git clone --recurse-submodules ${{ github.server_url }}/thirty30ww/auth-matrix.git -b ${{ env.TAG_NAME }}
          \`\`\`

          **æ–¹å¼äºŒï¼šä¸‹è½½å®Œæ•´åŒ…**  
          ç‚¹å‡»ä¸‹æ–¹ \`auth-matrix-${{ env.TAG_NAME }}-full.zip\` è§£å‹å³ç”¨ã€‚
          EOF

      # æ­¥éª¤ 5ï¼šåˆ›å»º Releaseï¼ˆä½¿ç”¨æ–‡ä»¶å†…å®¹ä½œä¸ºæè¿°ï¼‰
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Auth-Matrix ${{ env.TAG_NAME }}"
          body_path: release-body.md  # ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹
          files: auth-matrix-${{ env.TAG_NAME }}-full.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}