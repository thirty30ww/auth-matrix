name: Auto Build and Release
on:
  push:
    tags: v*  # 监听 v 开头的标签（如 v1.0.0）

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 步骤 1：拉取代码（强制 HTTPS 协议拉取子模块）
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # 步骤 2：获取版本信息
      - name: Extract version info
        id: version-info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          cd backend
          BACKEND_TAG=$(git describe --tags --abbrev=0 || echo "unknown")
          cd ../frontend
          FRONTEND_TAG=$(git describe --tags --abbrev=0 || echo "unknown")
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV
          echo "FRONTEND_TAG=$FRONTEND_TAG" >> $GITHUB_ENV

      # 步骤 3：安全打包（修复递归复制问题）
      - name: Create full package
        run: |
          # 创建目标目录
          mkdir -p package
          # 复制文件（排除.git和.github）
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.DS_Store' \
            --exclude='package' \
            ./ package/
          # 重命名并压缩
          mv package auth-matrix-${{ env.TAG_NAME }}
          zip -r auth-matrix-${{ env.TAG_NAME }}-full.zip auth-matrix-${{ env.TAG_NAME }}

      # 步骤 4：生成动态 Release 描述
      - name: Generate release notes
        run: |
          cat << EOF > release-body.md
          ## 🚀 Auth-Matrix ${{ env.TAG_NAME }}

          ### 📦 Component Versions
          | Module  | Version   | Repository |
          |---------|-----------|------------|
          | Backend | ${{ env.BACKEND_TAG }} | [Link](${{ github.server_url }}/thirty30ww/auth-matrix-backend/tree/${{ env.BACKEND_TAG }}) |
          | Frontend| ${{ env.FRONTEND_TAG }} | [Link](${{ github.server_url }}/thirty30ww/auth-matrix-frontend/tree/${{ env.FRONTEND_TAG }}) |

          ### ⬇️ Installation
          **Option 1: Clone with submodules**
          \`\`\`bash
          git clone --recurse-submodules ${{ github.server_url }}/thirty30ww/auth-matrix.git -b ${{ env.TAG_NAME }}
          \`\`\`

          **Option 2: Download ZIP**  
          Use the \`auth-matrix-${{ env.TAG_NAME }}-full.zip\` attachment below.
          EOF

      # 步骤 5：创建 Release
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Auth-Matrix ${{ env.TAG_NAME }}"
          body_path: release-body.md
          files: auth-matrix-${{ env.TAG_NAME }}-full.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}