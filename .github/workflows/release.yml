name: 自动构建与发布
on:
  push:
    tags: v*  # 监听 v 开头的标签（如 v1.0.0）

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许创建 Release
    steps:
      # 步骤 1：拉取代码（含子模块和所有标签）
      - name: 拉取代码（含子模块）
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0  # 拉取完整历史记录（包含所有标签）
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 步骤 2：获取各仓库实际版本标签
      - name: 获取版本信息
        id: version-info
        run: |
          # 获取主仓库标签
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # 获取后端实际版本标签
          cd backend
          git fetch --tags --force
          BACKEND_TAG=$(git for-each-ref --sort=-creatordate --format '%(refname:short)' refs/tags | head -1)
          BACKEND_LINK="${{ github.server_url }}/thirty30ww/auth-matrix-backend/tree/${BACKEND_TAG}"
          cd ..
          
          # 获取前端实际版本标签
          cd frontend
          git fetch --tags --force
          FRONTEND_TAG=$(git for-each-ref --sort=-creatordate --format '%(refname:short)' refs/tags | head -1)
          FRONTEND_LINK="${{ github.server_url }}/thirty30ww/auth-matrix-frontend/tree/${FRONTEND_TAG}"
          cd ..
          
          # 输出环境变量
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
          echo "BACKEND_TAG=${BACKEND_TAG}" >> $GITHUB_ENV
          echo "FRONTEND_TAG=${FRONTEND_TAG}" >> $GITHUB_ENV
          echo "BACKEND_LINK=${BACKEND_LINK}" >> $GITHUB_ENV
          echo "FRONTEND_LINK=${FRONTEND_LINK}" >> $GITHUB_ENV

      # 步骤 3：安全打包
      - name: 创建完整代码包
        run: |
          mkdir -p package
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.DS_Store' \
            --exclude='package' \
            ./ package/
          mv package auth-matrix
          zip -r auth-matrix.zip auth-matrix

      # 步骤 4：生成中文 Release 描述
      - name: 生成发布说明
        run: |
          cat << EOF > release-body.md
          ## 🚀 Auth-Matrix ${{ env.TAG_NAME }}
          
          ### 📦 组件版本信息
          | 模块   | 版本       | 仓库地址                                                                 |
          |--------|------------|--------------------------------------------------------------------------|
          | 后端   | ${{ env.BACKEND_TAG }} | [查看后端](${{ env.BACKEND_LINK }}) |
          | 前端   | ${{ env.FRONTEND_TAG }} | [查看前端](${{ env.FRONTEND_LINK }}) |
          
          ### ⬇️ 获取代码
          **方式一：克隆仓库（推荐开发者）**
          \`\`\`bash
          git clone --recurse-submodules ${{ github.server_url }}/thirty30ww/auth-matrix.git -b ${{ env.TAG_NAME }}
          \`\`\`
          
          **方式二：下载完整包（适合部署）**  
          直接下载下方的 \`auth-matrix.zip\` 即可使用，无需额外配置。
          EOF

      # 步骤 5：创建 Release
      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Auth-Matrix ${{ env.TAG_NAME }}"
          body_path: release-body.md
          files: auth-matrix.zip
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}